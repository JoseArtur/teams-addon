import React, { useEffect, useState } from "react";
import {
  Text,
  Card,
  CardHeader,
  Button,
  Dialog,
  DialogTrigger,
  DialogSurface,
  DialogBody,
  DialogTitle,
  DialogContent,
  DialogActions,
  Input,
  Slider,
  Badge,
  Spinner,
  Checkbox,
} from "@fluentui/react-components";
import {
  Add20Regular,
  FireFilled,
} from "@fluentui/react-icons";

import { addBookToShelf, getCurricularBooks, getStudentHistory, registerReadingProgress } from "../services/api";
import { StudentBookDetails } from "./StudentBookDetails";
import { GetStudentInfoResponse } from "../services/api";
export function StudentDashboard({ studentInfo }: { studentInfo: GetStudentInfoResponse }) {
  const [loading, setLoading] = useState(true);
  const [books, setBooks] = useState<any[]>([]);
  const [selectedBook, setSelectedBook] = useState<any>(null);
  const [currentPage, setCurrentPage] = useState(0);
  const [badges, setBadges] = useState<string[]>([]);
  const [streak, setStreak] = useState(0);
  const [completedChapters, setCompletedChapters] = useState<number[]>([]);
  const [studentName, setStudentName] = useState<string>("");
  const [streakAnimating, setStreakAnimating] = useState(false);
  const [searchQuery, setSearchQuery] = useState("");
  const [results, setResults] = useState<any[]>([]);
  const [myBooks, setMyBooks] = useState<any[]>([]);
  const [availableCurricularBooks, setAvailableCurricularBooks] = useState<any[]>([]);
  const [selectedCurricularBooks, setSelectedCurricularBooks] = useState<string[]>([]);
  const [showCurricularFlyout, setShowCurricularFlyout] = useState(false);

  const toggleSelectBook = (titulo: string) => {
    setSelectedCurricularBooks((prev) =>
      prev.includes(titulo) ? prev.filter((t) => t !== titulo) : [...prev, titulo]
    );
  };

  const email = studentInfo?.email || "";
  const grade = studentInfo?.grade || "";

  useEffect(() => {
    getStudentHistory(email).then((data) => {
      console.log("Dados do aluno:", data);
      const enrichedBooks = data.currentlyReading.map((entry: any) => ({
        id: entry.book.id,
        title: entry.book.titulo,
        author: entry.book.autor,
        cover: entry.book.capa,
        totalPages: entry.book.paginas,
        currentPage: entry.currentPage || 0,
      }));
      setBooks(enrichedBooks);
      setBadges(data.badges || []);
      console.log("Badges:", data);
      setStreak(data.readingStreak || 0);
      console.log("Streak:", data.readingStreak);
      if (enrichedBooks.length > 0) setSelectedBook(enrichedBooks[0]);
      console.log("Livros:", enrichedBooks);
      setStudentName(studentInfo.name);

      console.log("Nome do aluno:", studentInfo.name);
      setLoading(false);
      console.log("ooks.length > 1 , books:", books.length >= 1 );
    });
  }, [email]);

  const handleOpenCurricularFlyout = async () => {
    try {
      const booksFromApi = await getCurricularBooks(grade);
      const notOwned = booksFromApi.filter((book: any) => !books.find((b) => b.title === book.titulo));
      setAvailableCurricularBooks(notOwned);
      setSelectedCurricularBooks([]);
      setShowCurricularFlyout(true);
    } catch (err) {
      console.error("Erro ao buscar livros curriculares:", err);
    }
  };

  const handleConfirmAddCurricular = async () => {
    const booksToAdd = availableCurricularBooks.filter((book) => selectedCurricularBooks.includes(book.titulo));
    for (const book of booksToAdd) {
      await addBookToShelf(email, { ...book, type: "curricular" });
    }
    setShowCurricularFlyout(false);
  
    // Recarrega os livros do estudante apÃ³s adicionar
    setLoading(true);
    const data = await getStudentHistory(email);
    const enrichedBooks = data.currentlyReading.map((entry: any) => ({
      id: entry.book.id,
      title: entry.book.titulo,
      author: entry.book.autor,
      cover: entry.book.capa,
      totalPages: entry.book.paginas,
      currentPage: entry.currentPage || 0,
    }));
    setBooks(enrichedBooks);
    if (enrichedBooks.length > 0) setSelectedBook(enrichedBooks[0]);
    setLoading(false);
  };
    
  const handleProgressSubmit = async () => {
    
    // Atualiza streak do backend
    const data = await getStudentHistory(email);
    const novoStreak = data.readingStreak || 0;
    if (novoStreak > streak) {
      setStreakAnimating(true);
      setTimeout(() => setStreakAnimating(false), 1200); // duraÃ§Ã£o da animaÃ§Ã£o
    }
    console.log("Streak atualizada:", novoStreak);
    setStreak(novoStreak);
  
    alert("Progresso atualizado com sucesso!");
  
    setBooks((prev) =>
      prev.map((book) =>
        book.id === selectedBook.id ? { ...book, currentPage } : book
      )
    );
  };

  if (loading) return <Spinner label="Carregando..." />;

  const progresso = selectedBook
  ? Math.round((selectedBook.currentPage / selectedBook.totalPages) * 100)
  : 0;

return (
  <div style={{ padding: "2rem" }}>
    <Text size={700} weight="bold">
      ðŸ‘‹ OlÃ¡, {studentName}!
    </Text>

    {!selectedBook && (
  <Card style={{ margin: "2rem 0", padding: 24, textAlign: "center" }}>
    <Text size={500}>VocÃª ainda nÃ£o tem livros em leitura. Adicione um livro para comeÃ§ar sua jornada!</Text>
    <Button
      appearance="primary"
      icon={<Add20Regular />}
      style={{ marginTop: 16 }}
      onClick={handleOpenCurricularFlyout}
          >
      Adicionar Livro
    </Button>
  </Card>
)}
    {books.length >= 1 && (
      <>
      
        <Text size={600} weight="semibold" style={{ marginTop: "2rem" }}>
          ðŸ“š Outros Livros em Leitura
        </Text>
        <div style={{ display: "flex", gap: "1rem", flexWrap: "wrap", marginTop: "1rem" }}>
          {books
            .filter((book) => !selectedBook || book.id !== selectedBook.id)
            .map((book) => (
              <Card key={book.id} style={{ width: "200px" }}>
                <img
                  src={book.cover}
                  alt="Capa do livro"
                  style={{ height: "100px", margin: "1rem auto", display: "block" }}
                />
                <Text weight="semibold">{book.title}</Text>
                <Text size={300}>Autor: {book.author}</Text>
                <Button
                  appearance="secondary"
                  style={{ marginTop: "0.5rem" }}
                  onClick={() => setSelectedBook(book)}
                >
                  Selecionar
                </Button>
              </Card>
            ))}
        </div>
      </>
    )}

      <Card style={{ marginTop: "2rem" }}>
      <CardHeader
  header={<Text weight="semibold">ðŸ”¥ Streak de Leitura</Text>}
  description={
    streak === 1
      ? "VocÃª estÃ¡ lendo hÃ¡ 1 dia seguido!"
      : `VocÃª estÃ¡ lendo hÃ¡ ${streak} dias seguidos!`
  }
/>
        <Text>
          Mantenha sua sequÃªncia de leitura para ganhar recompensas e medalhas!
        </Text>
        <div style={{ marginTop: "0.5rem" }}>
  {Array.from({ length: streak }).map((_, i) => (
    <FireFilled
      key={i}
      style={{
        color: "orange",
        marginRight: 4,
        transition: "transform 0.4s",
        transform: streakAnimating && i === streak - 1 ? "scale(1.5)" : "scale(1)"
      }}
    />
  ))}
</div>
      </Card>

      <Card style={{ marginTop: "1rem" }}>
        <CardHeader header={<Text weight="semibold">ðŸŽ– Medalhas Conquistadas</Text>} />
        <div style={{ display: "flex", gap: "0.5rem", flexWrap: "wrap" }}>
          {badges.map((badge: string, i: number) => (
            <Badge key={i} appearance="filled" color="brand">
              {badge}
            </Badge>
          ))}
        </div>
      </Card>

                <Dialog open={showCurricularFlyout} onOpenChange={(_, data) => !data.open && setShowCurricularFlyout(false)}>
                  <DialogSurface>
                    <DialogBody>
                      <DialogTitle>ðŸ“˜ Livros Curriculares do {grade}Âº ano</DialogTitle>
                      {availableCurricularBooks.length === 0 ? (
                        <Text>Todos os livros jÃ¡ estÃ£o na sua estante.</Text>
                      ) : (
                        <div style={{ display: "flex", flexDirection: "column", gap: 12, marginTop: 16 }}>
                          {availableCurricularBooks.map((book, i) => (
                            <div key={i} style={{ display: "flex", alignItems: "center", gap: 8 }}>
                              <Checkbox
                                checked={selectedCurricularBooks.includes(book.titulo)}
                                onChange={() => toggleSelectBook(book.titulo)}
                                label={`${book.titulo} â€“ ${book.autor}`}
                              />
                              {book.capa && (
                                <img src={book.capa} alt="Capa" style={{ height: 48, borderRadius: 4 }} />
                              )}
                            </div>
                          ))}
                        </div>
                      )}
                      <DialogActions>
                        <Button onClick={() => setShowCurricularFlyout(false)}>Cancelar</Button>
                        <Button appearance="primary" onClick={handleConfirmAddCurricular} disabled={selectedCurricularBooks.length === 0}>
                          Adicionar Ã  Estante
                        </Button>
                      </DialogActions>
                    </DialogBody>
                  </DialogSurface>
                </Dialog>
    </div>
    
    

  );
}
